{
  "title": "Envoy Gateway | Clusters",
  "panels": [
    {
      "id": 9,
      "targets": [
        {
          "expr": "sum(envoy_server_live{cluster_id=\"$workload_cluster\"})",
          "refId": "A"
        }
      ]
    },
    {
      "id": 12,
      "targets": [
        {
          "expr": "avg(envoy_server_uptime{cluster_id=\"$workload_cluster\"})",
          "refId": "A"
        }
      ]
    },
    {
      "id": 11,
      "targets": [
        {
          "expr": "sum(envoy_server_memory_allocated{cluster_id=\"$workload_cluster\"})",
          "refId": "A"
        }
      ]
    },
    {
      "id": 13,
      "targets": [
        {
          "expr": "sum(envoy_server_memory_heap_size{cluster_id=\"$workload_cluster\"})",
          "refId": "A"
        }
      ]
    },
    {
      "id": 19,
      "targets": [
        {
          "expr": "(sum(envoy_cluster_membership_healthy{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"})  - sum(envoy_cluster_membership_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}))",
          "refId": "A"
        }
      ]
    },
    {
      "id": 20,
      "targets": [
        {
          "expr": "(sum(envoy_cluster_membership_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"})-sum(envoy_cluster_membership_healthy{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"})) == bool 0",
          "refId": "A"
        }
      ]
    },
    {
      "id": 2,
      "targets": [
        {
          "expr": "sum(envoy_cluster_upstream_cx_active{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    },
    {
      "id": 4,
      "targets": [
        {
          "expr": "sum(irate(envoy_cluster_upstream_rq_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    },
    {
      "id": 15,
      "targets": [
        {
          "expr": "sum(irate(envoy_cluster_upstream_cx_rx_bytes_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (envoy_cluster_name)",
          "refId": "A"
        },
        {
          "expr": "sum(irate(envoy_cluster_upstream_cx_tx_bytes_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (envoy_cluster_name)",
          "refId": "B"
        }
      ]
    },
    {
      "id": 17,
      "targets": [
        {
          "expr": "sum(irate(envoy_http_downstream_cx_rx_bytes_total{cluster_id=\"$workload_cluster\", envoy_http_conn_manager_prefix=~\"http.*\"}[5m]))",
          "refId": "A"
        },
        {
          "expr": "sum(irate(envoy_http_downstream_cx_tx_bytes_total{cluster_id=\"$workload_cluster\", envoy_http_conn_manager_prefix=~\"http.*\"}[5m]))",
          "refId": "B"
        }
      ]
    },
    {
      "id": 22,
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (le, envoy_cluster_name))",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.9, sum(rate(envoy_cluster_upstream_rq_time_bucket{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (le, envoy_cluster_name))",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.5, sum(rate(envoy_cluster_upstream_rq_time_bucket{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"}[5m])) by (le, envoy_cluster_name))",
          "refId": "C"
        }
      ]
    },
    {
      "id": 24,
      "targets": [
        {
          "expr": "sum(rate(envoy_cluster_upstream_rq_xx{cluster_id=\"$workload_cluster\", envoy_response_code_class=~\"2\", envoy_cluster_name=~\"$cluster\"}[5m])) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    },
    {
      "id": 28,
      "targets": [
        {
          "expr": "sum(rate(envoy_cluster_upstream_rq_xx{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\", envoy_response_code_class=~\"4\"}[1m])) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    },
    {
      "id": 7,
      "targets": [
        {
          "expr": "sum(envoy_cluster_membership_healthy{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\"})",
          "refId": "A"
        },
        {
          "expr": "sum(envoy_cluster_membership_total{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\", service=~\"$service\"})",
          "refId": "B"
        }
      ]
    },
    {
      "id": 30,
      "targets": [
        {
          "expr": "sum(rate(envoy_cluster_upstream_rq_xx{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\", envoy_response_code_class=~\"5\"}[5m])) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    },
    {
      "id": 26,
      "targets": [
        {
          "expr": "sum(rate(envoy_cluster_upstream_rq_xx{cluster_id=\"$workload_cluster\", envoy_cluster_name=~\"$cluster\", envoy_response_code_class=~\"3\"}[5m])) by (envoy_cluster_name)",
          "refId": "A"
        }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "current": {
          "selected": false,
          "text": "",
          "value": ""
        },
        "datasource": {
          "uid": "$datasource"
        },
        "definition": "label_values(kubernetes_build_info, cluster_id)",
        "hide": 0,
        "includeAll": false,
        "label": "Workload Cluster",
        "multi": false,
        "name": "workload_cluster",
        "options": [],
        "query": {
          "query": "label_values(kubernetes_build_info, cluster_id)",
          "refId": "PrometheusVariableQueryEditor-VariableQuery"
        },
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "definition": "label_values(envoy_cluster_version{cluster_id=\"$workload_cluster\"}, envoy_cluster_name)",
        "name": "cluster",
        "label": "Envoy Cluster",
        "query": {
          "query": "label_values(envoy_cluster_version{cluster_id=\"$workload_cluster\"}, envoy_cluster_name)",
          "refId": "PrometheusVariableQueryEditor-VariableQuery"
        }
      }
    ]
  }
}
